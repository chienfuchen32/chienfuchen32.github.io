<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.102.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>Nginx Ingress Controller K8S Guide &#183; New Blog</title><meta name=description content><link type=text/css rel=stylesheet href=https://chienfuchen32.github.io/css/print.css media=print><link type=text/css rel=stylesheet href=https://chienfuchen32.github.io/css/poole.css><link type=text/css rel=stylesheet href=https://chienfuchen32.github.io/css/syntax.css><link type=text/css rel=stylesheet href=https://chienfuchen32.github.io/css/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body class=theme-base-0d><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://chienfuchen32.github.io/><h1>New Blog</h1></a><p class=lead>hello there!</p></div><nav><ul class=sidebar-nav><li><a href=https://chienfuchen32.github.io/>Home</a></li><li><a href=https://github.com/chienfuchen32/>Github</a></li><li><a href=https://chienfuchen32.github.io/tags/>Tags</a></li></ul></nav><p>&copy; 2022. All rights reserved.</p></div></aside><main class="content container"><div class=post><h1>Nginx Ingress Controller K8S Guide</h1><time datetime=2022-04-15T15:45:07+0800 class=post-date>Fri, Apr 15, 2022</time><h2 id=nginx-介紹>Nginx 介紹</h2><p>Nginx是非同步框架的網頁伺服器，也可以用作反向代理、負載平衡器和HTTP快取。
<img src=https://miro.medium.com/max/1024/1*TrNJZqECEj0eVuJDeNKtNQ.png alt=nginx></p><ul><li>設置範例</li></ul><pre tabindex=0><code class=language-conf data-lang=conf>server {
    listen       80;
    listen  [::]:80;
    server_name  localhost;

    listen 443 ssl default_server;
    ssl_certificate /tls/server.crt;
    ssl_certificate_key /tls/server.key;

    #charset koi8-r;
    #access_log  /var/log/nginx/host.access.log  main;

    location / {
        #root   /usr/share/nginx/html;
        #index  index.html index.htm;
		proxy_pass http://192.168.24.100:9090/;
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection &#34;Upgrade&#34;;
		proxy_set_header Host $host;
		proxy_connect_timeout 60s;
		proxy_read_timeout 300s;
		proxy_send_timeout 300s;
    }


    location /socket.io {
        proxy_pass http://192.168.24.100:9091/;
        #Version 1.1 is recommended for use with keepalive connections
        proxy_http_version 1.1; #WebSocket
        proxy_set_header Upgrade $http_upgrade; #WebSocket
        proxy_set_header Connection $connection_upgrade; #WebSocket       
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header Cookie $http_cookie;
    }

    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }

}
</code></pre><p>可以透過<code>nginx -s reload</code>讓nginx對新的配置生效</p><ul><li><a href=https://nginx.org/en/docs/beginners_guide.html>https://nginx.org/en/docs/beginners_guide.html</a></li><li><a href=https://nginx.org/en/docs/>https://nginx.org/en/docs/</a></li></ul><h2 id=k8s-service>K8S service</h2><p><img src=https://miro.medium.com/max/1094/1*YeBt0Z9BEA7T_tUO4iYQyQ.png alt=service>
K8S 定義 Service 這個 resource object，在 pod 的前方提供了一個抽象層，讓外部的服務可以用
domain name 的方式存取 pod，而 domain name &lt;–> Pod 這一段問題，就由 Service 來處理。 但利用
domain name 來存取終究還是需要一個 IP address，而每個 Service 都會自帶 VIP，讓 network traffic
有辦法正常送過來，並導到後方真正提供服務的 pod。</p><ul><li><a href=https://kubernetes.io/docs/concepts/services-networking/service/>https://kubernetes.io/docs/concepts/services-networking/service/</a></li><li><a href=https://godleon.github.io/blog/Kubernetes/k8s-Service-Overview/>https://godleon.github.io/blog/Kubernetes/k8s-Service-Overview/</a></li></ul><h2 id=k8s-ingress>K8S Ingress</h2><p><img src=https://miro.medium.com/max/1024/1*BYGsxY_GR-eZgNJfbbikzA.png alt=ingress>
Ingress是從Kubernetes叢集外部訪問到群集內部服務的方法之一</p><ul><li><a href=https://kubernetes.io/docs/concepts/services-networking/ingress/>https://kubernetes.io/docs/concepts/services-networking/ingress/</a></li></ul><h2 id=nginx-ingress-controller>Nginx Ingress controller</h2><p>為了讓Ingress資源工作，叢集必須有一個正在運行的Ingress controller，其功能實作如:</p><ul><li>SSL/TLS offloading</li><li>反向代理，域名解析</li><li>四層和七層區別網路封包轉導</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>Kubernetes                                                  Workstation
</span></span><span style=display:flex><span>+---------------------------------------------------+     +------------------+
</span></span><span style=display:flex><span>|                                                   |     |                  |
</span></span><span style=display:flex><span>|  +-----------+   apiserver        +------------+  |     |  +------------+  |
</span></span><span style=display:flex><span>|  |           |   proxy            |            |  |     |  |            |  |
</span></span><span style=display:flex><span>|  | apiserver |                    |  ingress   |  |     |  |  ingress   |  |
</span></span><span style=display:flex><span>|  |           |                    | controller |  |     |  | controller |  |
</span></span><span style=display:flex><span>|  |           |                    |            |  |     |  |            |  |
</span></span><span style=display:flex><span>|  |           |                    |            |  |     |  |            |  |
</span></span><span style=display:flex><span>|  |           |  service account/  |            |  |     |  |            |  |
</span></span><span style=display:flex><span>|  |           |  kubeconfig        |            |  |     |  |            |  |
</span></span><span style=display:flex><span>|  |           +&lt;-------------------+            |  |     |  |            |  |
</span></span><span style=display:flex><span>|  |           |                    |            |  |     |  |            |  |
</span></span><span style=display:flex><span>|  +------+----+      kubeconfig    +------+-----+  |     |  +------+-----+  |
</span></span><span style=display:flex><span>|         |&lt;--------------------------------------------------------|        |
</span></span><span style=display:flex><span>|                                                   |     |                  |
</span></span><span style=display:flex><span>+---------------------------------------------------+     +------------------+
</span></span></code></pre></div><ul><li><a href=https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/>https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/</a></li><li></li></ul><p><a href="https://www.f5points.com.tw/2021/10/27/ingress-controller-%E9%81%B8%E5%9E%8B%E6%8C%87%E5%8D%97%EF%BC%8C%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%EF%BC%9A%E7%A2%BA%E5%AE%9A%E9%9C%80%E6%B1%82/#:~:text=Ingress%20Controller%20%E6%98%AF%E4%B8%80%E7%A8%AE%E5%B0%88%E7%94%A8,%E9%80%B2%E5%85%A5%20Kubernetes%20%E9%9B%86%E7%BE%A4%E7%9A%84%E6%B5%81%E9%87%8F">https://www.f5points.com.tw/2021/10/27/ingress-controller-%E9%81%B8%E5%9E%8B%E6%8C%87%E5%8D%97%EF%BC%8C%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%EF%BC%9A%E7%A2%BA%E5%AE%9A%E9%9C%80%E6%B1%82/#:~:text=Ingress%20Controller%20%E6%98%AF%E4%B8%80%E7%A8%AE%E5%B0%88%E7%94%A8,%E9%80%B2%E5%85%A5%20Kubernetes%20%E9%9B%86%E7%BE%A4%E7%9A%84%E6%B5%81%E9%87%8F</a></p><ul><li><a href=https://kubernetes.github.io/ingress-nginx/how-it-works/>https://kubernetes.github.io/ingress-nginx/how-it-works/</a></li></ul><h2 id=常見使用情形範例與除錯方式>常見使用情形範例與除錯方式</h2><h3 id=dnsip避免影響正式環境>DNS,IP,避免影響正式環境</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span># /etc/hosts
</span></span><span style=display:flex><span># 20220415 lab
</span></span><span style=display:flex><span>192.168.24.1 lab-20220415.foo.com
</span></span><span style=display:flex><span>192.168.24.1 lab-20220415.bar.foo.com
</span></span></code></pre></div><h3 id=backend-service-k8s-pod-or-external-service>Backend service (K8S pod or external service)</h3><ul><li>於pod/container中使用<code>curl</code> / <code>wget</code> 工具:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl localhost:5000/healthz
</span></span></code></pre></div><ul><li>透過本機連線來除錯 service port forward (cli or lens)</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl port-forward -n 20220415-nginx-lab service/nginx-lab 25000/5000
</span></span></code></pre></div><ul><li><a href=https://kubernetes.io/docs/tasks/access-application-cluster/port-forward-access-application-cluster/>https://kubernetes.io/docs/tasks/access-application-cluster/port-forward-access-application-cluster/</a></li></ul><h3 id=rewrite>rewrite</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>apiVersion: networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: Ingress
</span></span></span><span style=display:flex><span><span style=color:#e6db74>metadata:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    nginx.ingress.kubernetes.io/rewrite-target: /$2
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  name: rewrite
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#e6db74>spec:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  ingressClassName: nginx
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  rules:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  - host: rewrite.bar.com
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    http:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      paths:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      - path: /something(/|$)(.*)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        pathType: Prefix
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        backend:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          service:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            name: http-svc
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            port: 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              number: 80
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#39;</span> | kubectl create -f -
</span></span></code></pre></div><p>In this ingress definition, any characters captured by (.*) will be assigned to the
placeholder $2, which is then used as a parameter in the rewrite-target annotation.
For example, the ingress definition above will result in the following rewrites:</p><ol><li><code>rewrite.bar.com/something</code> rewrites to <code>rewrite.bar.com</code></li><li><code>rewrite.bar.com/something/</code> rewrites to <code>rewrite.bar.com/</code></li><li><code>rewrite.bar.com/something/new</code> rewrites to <code>rewrite.bar.com/new</code></li></ol><pre tabindex=0><code>example

rewrite.bar.com/something/new    |------------|      IP:PORT/new          |-----------------|
--------------------------------&gt;|   Nginx    |--------------------------&gt;| backend service |
                                 |------------|                           |-----------------|
</code></pre><p><a href=https://kubernetes.github.io/ingress-nginx/examples/rewrite/>https://kubernetes.github.io/ingress-nginx/examples/rewrite/</a></p><h3 id=ssltls-offloading>SSL/TLS Offloading</h3><ul><li><a href=https://www.nginx.com/blog/nginx-ssl/>https://www.nginx.com/blog/nginx-ssl/</a></li></ul><h3 id=websocket>Websocket</h3><ul><li><a href=https://nginx.org/en/docs/http/websocket.html>https://nginx.org/en/docs/http/websocket.html</a></li><li></li></ul><p><a href=https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#custom-timeouts>https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#custom-timeouts</a></p><h3 id=tcpudp-service>TCP/UDP service</h3><ul><li><a href=https://nginx.org/en/docs/stream/stream_processing.html>https://nginx.org/en/docs/stream/stream_processing.html</a></li><li><a href=https://kubernetes.github.io/ingress-nginx/user-guide/exposing-tcp-udp-services/>https://kubernetes.github.io/ingress-nginx/user-guide/exposing-tcp-udp-services/</a></li></ul><h1 id=lab-and-demo>lab and demo</h1><ul><li><a href=https://github.com/chienfuchen32/k8s-nginx-ingress-hands-on-lab>https://github.com/chienfuchen32/k8s-nginx-ingress-hands-on-lab</a></li></ul><ol><li>develope app</li><li>deploy</li></ol><ul><li>examples
<a href=https://lab-20220415.foo.com/>https://lab-20220415.foo.com/</a>
<a href=https://lab-20220415.bar.foo.com>https://lab-20220415.bar.foo.com</a>
<a href=https://lab-20220415.foo.com/nginx-lab/>https://lab-20220415.foo.com/nginx-lab/</a>
<a href=https://lab-20220415.foo.com/nginx-lab-rewrite/>https://lab-20220415.foo.com/nginx-lab-rewrite/</a></li></ul><h1 id=特殊情境>特殊情境</h1><h2 id=若服務不在k8s中在同一個lan的vm可以從k8s叢集連線的到>若服務不在K8S中，在同一個LAN的VM，可以從K8S叢集連線的到</h2><ul><li>假設服務跑在http://192.168.24.101:5000</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>external-svc</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>app</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>port</span>: <span style=color:#ae81ff>5000</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>5000</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>ClusterIP</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>sessionAffinity</span>: <span style=color:#ae81ff>None</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Endpoints</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>external-svc</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>app</span>
</span></span><span style=display:flex><span><span style=color:#f92672>subsets</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>addresses</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>ip</span>: <span style=color:#ae81ff>192.168.24.101</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>port</span>: <span style=color:#ae81ff>5000</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>extensions/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Ingress</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>external-ingress</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>app</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>external-ingress</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>kubernetes.io/ingress.class</span>: <span style=color:#ae81ff>nginx</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>nginx.ingress.kubernetes.io/rewrite-target</span>: <span style=color:#ae81ff>/$2</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>nginx.ingress.kubernetes.io/use-regex</span>: <span style=color:#e6db74>&#39;true&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>rules</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>host</span>: <span style=color:#ae81ff>mydomain.com</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>paths</span>:
</span></span><span style=display:flex><span>          - <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/path(/|$)(.*)</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>pathType</span>: <span style=color:#ae81ff>ImplementationSpecific</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>backend</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>serviceName</span>: <span style=color:#ae81ff>external-svc</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>servicePort</span>: <span style=color:#ae81ff>5000</span>
</span></span></code></pre></div></div></main><script async src="https://www.googletagmanager.com/gtag/js?id=G-3SNCDP141D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3SNCDP141D",{anonymize_ip:!1})}</script></body></html>