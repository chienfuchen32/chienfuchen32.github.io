<!doctype html><html lang=en-us><head><meta charset=utf-8><meta content="Jeff’s note" name=apple-mobile-web-app-title><meta content="Ingress,Kubernetes,Reverse Proxy" name=keywords><meta content="#0d6efd" name=theme-color><meta content="width=device-width,initial-scale=1" name=viewport><meta property="og:url" content="https://chienfuchen32.github.io/posts/nginx-ingress-controller-k8s-guide/"><meta property="og:site_name" content="Jeff's note"><meta property="og:title" content="Nginx Ingress Controller K8S Guide"><meta property="og:description" content='Nginx 介紹 Nginx是非同步框架的網頁伺服器，也可以用作反向代理、負載平衡器和HTTP快取。 設置範例 server { listen 80; listen [::]:80; server_name localhost; listen 443 ssl default_server; ssl_certificate /tls/server.crt; ssl_certificate_key /tls/server.key; #charset koi8-r; #access_log /var/log/nginx/host.access.log main; location / { #root /usr/share/nginx/html; #index index.html index.htm; proxy_pass http://192.168.24.100:9090/; proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection "Upgrade"; proxy_set_header Host $host; proxy_connect_timeout 60s; proxy_read_timeout 300s; proxy_send_timeout 300s; } location /socket.io { proxy_pass http://192.168.24.100:9091/; #Version 1.1 is recommended for use with keepalive connections proxy_http_version 1.1; #WebSocket proxy_set_header Upgrade $http_upgrade; #WebSocket proxy_set_header Connection $connection_upgrade; #WebSocket proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto https; proxy_set_header Cookie $http_cookie; } error_page 500 502 503 504 /50x.html; location = /50x.html { root /usr/share/nginx/html; } } 可以透過nginx -s reload讓nginx對新的配置生效'><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-15T15:45:07+08:00"><meta property="article:modified_time" content="2022-04-15T15:45:07+08:00"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="Ingress"><meta property="article:tag" content="Reverse Proxy"><meta name=twitter:card content="summary"><meta name=twitter:title content="Nginx Ingress Controller K8S Guide"><meta name=twitter:description content='Nginx 介紹 Nginx是非同步框架的網頁伺服器，也可以用作反向代理、負載平衡器和HTTP快取。 設置範例 server { listen 80; listen [::]:80; server_name localhost; listen 443 ssl default_server; ssl_certificate /tls/server.crt; ssl_certificate_key /tls/server.key; #charset koi8-r; #access_log /var/log/nginx/host.access.log main; location / { #root /usr/share/nginx/html; #index index.html index.htm; proxy_pass http://192.168.24.100:9090/; proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection "Upgrade"; proxy_set_header Host $host; proxy_connect_timeout 60s; proxy_read_timeout 300s; proxy_send_timeout 300s; } location /socket.io { proxy_pass http://192.168.24.100:9091/; #Version 1.1 is recommended for use with keepalive connections proxy_http_version 1.1; #WebSocket proxy_set_header Upgrade $http_upgrade; #WebSocket proxy_set_header Connection $connection_upgrade; #WebSocket proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto https; proxy_set_header Cookie $http_cookie; } error_page 500 502 503 504 /50x.html; location = /50x.html { root /usr/share/nginx/html; } } 可以透過nginx -s reload讓nginx對新的配置生效'><title>Nginx Ingress Controller K8S Guide · Posts · Jeff’s note</title><link href=/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link href=/favicon-96x96.png rel=icon sizes=96x96 type=image/png><link href=/favicon.ico rel="shortcut icon"><link href=/favicon.svg rel=icon type=image/svg+xml><link href=/web-app-manifest-192x192.png rel=icon type=image/png><link href=/web-app-manifest-512x512.png rel=icon type=image/png><link href=/site.webmanifest rel=manifest><link crossorigin=anonymous href=/css/paige/paige.b7711eef70c3d21744de914df8dc5999ba4df0c3.min.3b5b583ef4a5c7e93743e15582585c9c2a7621b8fef6c9c7ad4bac50e4781f05.css integrity="sha256-O1tYPvSlx+k3Q+FVglhcnCp2Ibj+9snHrUusUOR4HwU=" referrerpolicy=no-referrer rel=stylesheet><link crossorigin=anonymous href=/css/paige/bootstrap/paige.37b3fc66686a7163af8180c5fb0fc6ab835321eb.min.55516fbe90a5aad46d6dbc2441c1c193504ee32cb1eef5070ab589c776231a4c.css integrity="sha256-VVFvvpClqtRtbbwkQcHBk1BO4yyx7vUHCrWJx3YjGkw=" referrerpolicy=no-referrer rel=stylesheet><link crossorigin=anonymous href=/css/paige/bootstrap-icons/bootstrap-icons.min.755bbaf60ab33d8f6213c74d33daea2ef5bf22d15245142a27529f8c1d7e80f1.css integrity="sha256-dVu69gqzPY9iE8dNM9rqLvW/ItFSRRQqJ1KfjB1+gPE=" referrerpolicy=no-referrer rel=stylesheet></head><body><div class=container><div class=row><div class="col mt-3" id=paige-site><header id=paige-site-header><div class="display-1 fw-bold text-center" id=paige-site-title><a class="text-body text-decoration-none" href=/>Jeff&rsquo;s note</a></div><nav aria-label=Menu class=paige-row-tall id=paige-site-menu><ul class="align-items-center justify-content-center nav"><li class=nav-item><a class="nav-link text-decoration-underline" href=/about/>About</a></li><li class=nav-item><a aria-current=page class="active fw-bold text-body nav-link text-decoration-underline" href=/posts/>Posts</a></li><li class=nav-item><a class="nav-link text-decoration-underline" href=/tags/>Tags</a></li></ul></nav><nav aria-label=Breadcrumbs class=paige-row-tall id=paige-site-breadcrumbs><div class="d-flex justify-content-center"><ol class="breadcrumb mb-0"><li class=breadcrumb-item><a href=/>Home</a></li><li class=breadcrumb-item><a href=/posts/>Posts</a></li></ol></div></nav></header><article class="align-items-center d-flex flex-column paige-kind-page paige-status-draft paige-status-unpublished" id=paige-page><header class="mw-100 text-center" id=paige-page-header><h1 class=fw-bold id=paige-page-title>Nginx Ingress Controller K8S Guide</h1><div><p class="paige-row-short text-secondary" id=paige-page-keywords><a class="link-secondary paige-page-keyword-tag" href=/tags/ingress/>Ingress</a>
·
<a class="link-secondary paige-page-keyword-tag" href=/tags/kubernetes/>Kubernetes</a>
·
<a class="link-secondary paige-page-keyword-tag" href=/tags/reverse-proxy/>Reverse Proxy</a></p><p class="paige-row-short text-secondary" id=paige-page-date><time datetime=2022-04-15>April 15, 2022</time></p><p class="paige-row-short text-secondary" id=paige-page-word-count>546 words</p><p class="paige-row-short text-secondary" id=paige-page-reading-time>3 minutes</p></div><div class="align-items-center d-flex flex-column paige-row-tall text-start" id=paige-page-toc><div class="border rounded" style="padding:1rem 2rem 0 1rem"><nav id=TableOfContents><ul><li><a href=#nginx-介紹>Nginx 介紹</a></li><li><a href=#k8s-service>K8S service</a></li><li><a href=#k8s-ingress>K8S Ingress</a></li><li><a href=#nginx-ingress-controller>Nginx Ingress controller</a></li><li><a href=#常見使用情形範例與除錯方式>常見使用情形範例與除錯方式</a><ul><li><a href=#dnsip避免影響正式環境>DNS,IP,避免影響正式環境</a></li><li><a href=#backend-service-k8s-pod-or-external-service>Backend service (K8S pod or external service)</a></li><li><a href=#rewrite>rewrite</a></li><li><a href=#ssltls-offloading>SSL/TLS Offloading</a></li><li><a href=#websocket>Websocket</a></li><li><a href=#tcpudp-service>TCP/UDP service</a></li></ul></li></ul><ul><li><a href=#若服務不在k8s中在同一個lan的vm可以從k8s叢集連線的到>若服務不在K8S中，在同一個LAN的VM，可以從K8S叢集連線的到</a></li></ul></nav></div></div></header><main class=mw-100 id=paige-page-content><h2 class=h5 id=nginx-介紹><a href=#nginx-%e4%bb%8b%e7%b4%b9 style=color:rgba(var(--bs-body-color-rgb),var(--bs-text-opacity));text-decoration:none>Nginx 介紹</a></h2><p>Nginx是非同步框架的網頁伺服器，也可以用作反向代理、負載平衡器和HTTP快取。
<img src=https://miro.medium.com/max/1024/1*TrNJZqECEj0eVuJDeNKtNQ.png alt=nginx></p><ul><li>設置範例</li></ul><pre tabindex=0><code class=language-conf data-lang=conf>server {
    listen       80;
    listen  [::]:80;
    server_name  localhost;

    listen 443 ssl default_server;
    ssl_certificate /tls/server.crt;
    ssl_certificate_key /tls/server.key;

    #charset koi8-r;
    #access_log  /var/log/nginx/host.access.log  main;

    location / {
        #root   /usr/share/nginx/html;
        #index  index.html index.htm;
		proxy_pass http://192.168.24.100:9090/;
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection &#34;Upgrade&#34;;
		proxy_set_header Host $host;
		proxy_connect_timeout 60s;
		proxy_read_timeout 300s;
		proxy_send_timeout 300s;
    }


    location /socket.io {
        proxy_pass http://192.168.24.100:9091/;
        #Version 1.1 is recommended for use with keepalive connections
        proxy_http_version 1.1; #WebSocket
        proxy_set_header Upgrade $http_upgrade; #WebSocket
        proxy_set_header Connection $connection_upgrade; #WebSocket       
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header Cookie $http_cookie;
    }

    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }

}
</code></pre><p>可以透過<code>nginx -s reload</code>讓nginx對新的配置生效</p><ul><li><a href=https://nginx.org/en/docs/beginners_guide.html rel=external>https://nginx.org/en/docs/beginners_guide.html</a></li><li><a href=https://nginx.org/en/docs/ rel=external>https://nginx.org/en/docs/</a></li></ul><h2 class=h5 id=k8s-service><a href=#k8s-service style=color:rgba(var(--bs-body-color-rgb),var(--bs-text-opacity));text-decoration:none>K8S service</a></h2><p><img src=https://miro.medium.com/max/1094/1*YeBt0Z9BEA7T_tUO4iYQyQ.png alt=service>
K8S 定義 Service 這個 resource object，在 pod 的前方提供了一個抽象層，讓外部的服務可以用
domain name 的方式存取 pod，而 domain name &lt;–> Pod 這一段問題，就由 Service 來處理。 但利用
domain name 來存取終究還是需要一個 IP address，而每個 Service 都會自帶 VIP，讓 network traffic
有辦法正常送過來，並導到後方真正提供服務的 pod。</p><ul><li><a href=https://kubernetes.io/docs/concepts/services-networking/service/ rel=external>https://kubernetes.io/docs/concepts/services-networking/service/</a></li><li><a href=https://godleon.github.io/blog/Kubernetes/k8s-Service-Overview/ rel=external>https://godleon.github.io/blog/Kubernetes/k8s-Service-Overview/</a></li></ul><h2 class=h5 id=k8s-ingress><a href=#k8s-ingress style=color:rgba(var(--bs-body-color-rgb),var(--bs-text-opacity));text-decoration:none>K8S Ingress</a></h2><p><img src=https://miro.medium.com/max/1024/1*BYGsxY_GR-eZgNJfbbikzA.png alt=ingress>
Ingress是從Kubernetes叢集外部訪問到群集內部服務的方法之一</p><ul><li><a href=https://kubernetes.io/docs/concepts/services-networking/ingress/ rel=external>https://kubernetes.io/docs/concepts/services-networking/ingress/</a></li></ul><h2 class=h5 id=nginx-ingress-controller><a href=#nginx-ingress-controller style=color:rgba(var(--bs-body-color-rgb),var(--bs-text-opacity));text-decoration:none>Nginx Ingress controller</a></h2><p>為了讓Ingress資源工作，叢集必須有一個正在運行的Ingress controller，其功能實作如:</p><ul><li>SSL/TLS offloading</li><li>反向代理，域名解析</li><li>四層和七層區別網路封包轉導</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>Kubernetes                                                  Workstation
</span></span><span style=display:flex><span>+---------------------------------------------------+     +------------------+
</span></span><span style=display:flex><span>|                                                   |     |                  |
</span></span><span style=display:flex><span>|  +-----------+   apiserver        +------------+  |     |  +------------+  |
</span></span><span style=display:flex><span>|  |           |   proxy            |            |  |     |  |            |  |
</span></span><span style=display:flex><span>|  | apiserver |                    |  ingress   |  |     |  |  ingress   |  |
</span></span><span style=display:flex><span>|  |           |                    | controller |  |     |  | controller |  |
</span></span><span style=display:flex><span>|  |           |                    |            |  |     |  |            |  |
</span></span><span style=display:flex><span>|  |           |                    |            |  |     |  |            |  |
</span></span><span style=display:flex><span>|  |           |  service account/  |            |  |     |  |            |  |
</span></span><span style=display:flex><span>|  |           |  kubeconfig        |            |  |     |  |            |  |
</span></span><span style=display:flex><span>|  |           +&lt;-------------------+            |  |     |  |            |  |
</span></span><span style=display:flex><span>|  |           |                    |            |  |     |  |            |  |
</span></span><span style=display:flex><span>|  +------+----+      kubeconfig    +------+-----+  |     |  +------+-----+  |
</span></span><span style=display:flex><span>|         |&lt;--------------------------------------------------------|        |
</span></span><span style=display:flex><span>|                                                   |     |                  |
</span></span><span style=display:flex><span>+---------------------------------------------------+     +------------------+
</span></span></code></pre></div><ul><li><a href=https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/ rel=external>https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/</a></li><li></li></ul><p><a href="https://www.f5points.com.tw/2021/10/27/ingress-controller-%E9%81%B8%E5%9E%8B%E6%8C%87%E5%8D%97%EF%BC%8C%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%EF%BC%9A%E7%A2%BA%E5%AE%9A%E9%9C%80%E6%B1%82/#:~:text=Ingress%20Controller%20%E6%98%AF%E4%B8%80%E7%A8%AE%E5%B0%88%E7%94%A8,%E9%80%B2%E5%85%A5%20Kubernetes%20%E9%9B%86%E7%BE%A4%E7%9A%84%E6%B5%81%E9%87%8F" rel=external>https://www.f5points.com.tw/2021/10/27/ingress-controller-%E9%81%B8%E5%9E%8B%E6%8C%87%E5%8D%97%EF%BC%8C%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%EF%BC%9A%E7%A2%BA%E5%AE%9A%E9%9C%80%E6%B1%82/#:~:text=Ingress%20Controller%20%E6%98%AF%E4%B8%80%E7%A8%AE%E5%B0%88%E7%94%A8,%E9%80%B2%E5%85%A5%20Kubernetes%20%E9%9B%86%E7%BE%A4%E7%9A%84%E6%B5%81%E9%87%8F</a></p><ul><li><a href=https://kubernetes.github.io/ingress-nginx/how-it-works/ rel=external>https://kubernetes.github.io/ingress-nginx/how-it-works/</a></li></ul><h2 class=h5 id=常見使用情形範例與除錯方式><a href=#%e5%b8%b8%e8%a6%8b%e4%bd%bf%e7%94%a8%e6%83%85%e5%bd%a2%e7%af%84%e4%be%8b%e8%88%87%e9%99%a4%e9%8c%af%e6%96%b9%e5%bc%8f style=color:rgba(var(--bs-body-color-rgb),var(--bs-text-opacity));text-decoration:none>常見使用情形範例與除錯方式</a></h2><h3 class=h6 id=dnsip避免影響正式環境><a href=#dnsip%e9%81%bf%e5%85%8d%e5%bd%b1%e9%9f%bf%e6%ad%a3%e5%bc%8f%e7%92%b0%e5%a2%83 style=color:rgba(var(--bs-body-color-rgb),var(--bs-text-opacity));text-decoration:none>DNS,IP,避免影響正式環境</a></h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span># /etc/hosts
</span></span><span style=display:flex><span># 20220415 lab
</span></span><span style=display:flex><span>192.168.24.1 lab-20220415.foo.com
</span></span><span style=display:flex><span>192.168.24.1 lab-20220415.bar.foo.com
</span></span></code></pre></div><h3 class=h6 id=backend-service-k8s-pod-or-external-service><a href=#backend-service-k8s-pod-or-external-service style=color:rgba(var(--bs-body-color-rgb),var(--bs-text-opacity));text-decoration:none>Backend service (K8S pod or external service)</a></h3><ul><li>於pod/container中使用<code>curl</code> / <code>wget</code> 工具:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl localhost:5000/healthz
</span></span></code></pre></div><ul><li>透過本機連線來除錯 service port forward (cli or lens)</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl port-forward -n 20220415-nginx-lab service/nginx-lab 25000/5000
</span></span></code></pre></div><ul><li><a href=https://kubernetes.io/docs/tasks/access-application-cluster/port-forward-access-application-cluster/ rel=external>https://kubernetes.io/docs/tasks/access-application-cluster/port-forward-access-application-cluster/</a></li></ul><h3 class=h6 id=rewrite><a href=#rewrite style=color:rgba(var(--bs-body-color-rgb),var(--bs-text-opacity));text-decoration:none>rewrite</a></h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#a31515>&#39;
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: Ingress
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    nginx.ingress.kubernetes.io/rewrite-target: /$2
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: rewrite
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  ingressClassName: nginx
</span></span></span><span style=display:flex><span><span style=color:#a31515>  rules:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - host: rewrite.bar.com
</span></span></span><span style=display:flex><span><span style=color:#a31515>    http:
</span></span></span><span style=display:flex><span><span style=color:#a31515>      paths:
</span></span></span><span style=display:flex><span><span style=color:#a31515>      - path: /something(/|$)(.*)
</span></span></span><span style=display:flex><span><span style=color:#a31515>        pathType: Prefix
</span></span></span><span style=display:flex><span><span style=color:#a31515>        backend:
</span></span></span><span style=display:flex><span><span style=color:#a31515>          service:
</span></span></span><span style=display:flex><span><span style=color:#a31515>            name: http-svc
</span></span></span><span style=display:flex><span><span style=color:#a31515>            port: 
</span></span></span><span style=display:flex><span><span style=color:#a31515>              number: 80
</span></span></span><span style=display:flex><span><span style=color:#a31515>&#39;</span> | kubectl create -f -
</span></span></code></pre></div><p>In this ingress definition, any characters captured by (.*) will be assigned to the
placeholder $2, which is then used as a parameter in the rewrite-target annotation.
For example, the ingress definition above will result in the following rewrites:</p><ol><li><code>rewrite.bar.com/something</code> rewrites to <code>rewrite.bar.com</code></li><li><code>rewrite.bar.com/something/</code> rewrites to <code>rewrite.bar.com/</code></li><li><code>rewrite.bar.com/something/new</code> rewrites to <code>rewrite.bar.com/new</code></li></ol><pre tabindex=0><code>example

rewrite.bar.com/something/new    |------------|      IP:PORT/new          |-----------------|
--------------------------------&gt;|   Nginx    |--------------------------&gt;| backend service |
                                 |------------|                           |-----------------|
</code></pre><p><a href=https://kubernetes.github.io/ingress-nginx/examples/rewrite/ rel=external>https://kubernetes.github.io/ingress-nginx/examples/rewrite/</a></p><h3 class=h6 id=ssltls-offloading><a href=#ssltls-offloading style=color:rgba(var(--bs-body-color-rgb),var(--bs-text-opacity));text-decoration:none>SSL/TLS Offloading</a></h3><ul><li><a href=https://www.nginx.com/blog/nginx-ssl/ rel=external>https://www.nginx.com/blog/nginx-ssl/</a></li></ul><h3 class=h6 id=websocket><a href=#websocket style=color:rgba(var(--bs-body-color-rgb),var(--bs-text-opacity));text-decoration:none>Websocket</a></h3><ul><li><a href=https://nginx.org/en/docs/http/websocket.html rel=external>https://nginx.org/en/docs/http/websocket.html</a></li><li></li></ul><p><a href=https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#custom-timeouts rel=external>https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#custom-timeouts</a></p><h3 class=h6 id=tcpudp-service><a href=#tcpudp-service style=color:rgba(var(--bs-body-color-rgb),var(--bs-text-opacity));text-decoration:none>TCP/UDP service</a></h3><ul><li><a href=https://nginx.org/en/docs/stream/stream_processing.html rel=external>https://nginx.org/en/docs/stream/stream_processing.html</a></li><li><a href=https://kubernetes.github.io/ingress-nginx/user-guide/exposing-tcp-udp-services/ rel=external>https://kubernetes.github.io/ingress-nginx/user-guide/exposing-tcp-udp-services/</a></li></ul><h1 class=h4 id=lab-and-demo><a href=#lab-and-demo style=color:rgba(var(--bs-body-color-rgb),var(--bs-text-opacity));text-decoration:none>lab and demo</a></h1><ul><li><a href=https://github.com/chienfuchen32/k8s-nginx-ingress-hands-on-lab rel=external>https://github.com/chienfuchen32/k8s-nginx-ingress-hands-on-lab</a></li></ul><ol><li>develope app</li><li>deploy</li></ol><ul><li>examples
<a href=https://lab-20220415.foo.com/ rel=external>https://lab-20220415.foo.com/</a>
<a href=https://lab-20220415.bar.foo.com rel=external>https://lab-20220415.bar.foo.com</a>
<a href=https://lab-20220415.foo.com/nginx-lab/ rel=external>https://lab-20220415.foo.com/nginx-lab/</a>
<a href=https://lab-20220415.foo.com/nginx-lab-rewrite/ rel=external>https://lab-20220415.foo.com/nginx-lab-rewrite/</a></li></ul><h1 class=h4 id=特殊情境><a href=#%e7%89%b9%e6%ae%8a%e6%83%85%e5%a2%83 style=color:rgba(var(--bs-body-color-rgb),var(--bs-text-opacity));text-decoration:none>特殊情境</a></h1><h2 class=h5 id=若服務不在k8s中在同一個lan的vm可以從k8s叢集連線的到><a href=#%e8%8b%a5%e6%9c%8d%e5%8b%99%e4%b8%8d%e5%9c%a8k8s%e4%b8%ad%e5%9c%a8%e5%90%8c%e4%b8%80%e5%80%8blan%e7%9a%84vm%e5%8f%af%e4%bb%a5%e5%be%9ek8s%e5%8f%a2%e9%9b%86%e9%80%a3%e7%b7%9a%e7%9a%84%e5%88%b0 style=color:rgba(var(--bs-body-color-rgb),var(--bs-text-opacity));text-decoration:none>若服務不在K8S中，在同一個LAN的VM，可以從K8S叢集連線的到</a></h2><ul><li>假設服務跑在http://192.168.24.101:5000</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Service
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: external-svc
</span></span><span style=display:flex><span>  namespace: app
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  ports:
</span></span><span style=display:flex><span>    - protocol: TCP
</span></span><span style=display:flex><span>      port: 5000
</span></span><span style=display:flex><span>      targetPort: 5000
</span></span><span style=display:flex><span>  type: ClusterIP
</span></span><span style=display:flex><span>  sessionAffinity: None
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Endpoints
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: external-svc
</span></span><span style=display:flex><span>  namespace: app
</span></span><span style=display:flex><span>subsets:
</span></span><span style=display:flex><span>  - addresses:
</span></span><span style=display:flex><span>      - ip: 192.168.24.101
</span></span><span style=display:flex><span>    ports:
</span></span><span style=display:flex><span>      - port: 5000
</span></span><span style=display:flex><span>        protocol: TCP
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: extensions/v1beta1
</span></span><span style=display:flex><span>kind: Ingress
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: external-ingress
</span></span><span style=display:flex><span>  namespace: app
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>    app: external-ingress
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    kubernetes.io/ingress.class: nginx
</span></span><span style=display:flex><span>    nginx.ingress.kubernetes.io/rewrite-target: /$2
</span></span><span style=display:flex><span>    nginx.ingress.kubernetes.io/use-regex: <span style=color:#a31515>&#39;true&#39;</span>
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  rules:
</span></span><span style=display:flex><span>    - host: mydomain.com
</span></span><span style=display:flex><span>      http:
</span></span><span style=display:flex><span>        paths:
</span></span><span style=display:flex><span>          - path: /path(/|$)(.*)
</span></span><span style=display:flex><span>            pathType: ImplementationSpecific
</span></span><span style=display:flex><span>            backend:
</span></span><span style=display:flex><span>              serviceName: external-svc
</span></span><span style=display:flex><span>              servicePort: 5000
</span></span></code></pre></div></main><footer class=mw-100 id=paige-page-footer><div id=paige-page-siblings><div class="paige-row-short text-center text-secondary" id=paige-page-next><a class=link-secondary href=https://chienfuchen32.github.io/posts/k8s-guide-for-developer/>Kubernetes Guide for Developer</a> &#8250;</div><div class="paige-row-short text-center text-secondary" id=paige-page-prev>&#8249; <a class=link-secondary href=https://chienfuchen32.github.io/posts/continuous-integration-continuous-deployment/>Continuous Integration Continuous Deployment</a></div></div></footer></article><footer id=paige-site-footer><p class="paige-row-short text-center text-secondary" id=paige-site-credit><a class="link-secondary text-decoration-none" href=https://github.com/willfaught/paige>Paige Theme</a></p></footer></div></div></div><script crossorigin=anonymous defer integrity="sha256-GdpV5fXTSprZ1he71RUKGZl0E3HtqxFXvbylEdkWmRQ=" referrerpolicy=no-referrer src=/js/paige/bootstrap/bootstrap.bundle.min.19da55e5f5d34a9ad9d617bbd5150a1999741371edab1157bdbca511d9169914.js></script><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","abstract":" Nginx 介紹 Nginx是非同步框架的網頁伺服器，也可以用作反向代理、負載平衡器和HTTP快取。 設置範例 server { listen 80; listen [::]:80; server_name localhost; listen 443 ssl default_server; ssl_certificate /tls/server.crt; ssl_certificate_key /tls/server.key; #charset koi8-r; #access_log /var/log/nginx/host.access.log main; location / { #root /usr/share/nginx/html; #index index.html index.htm; proxy_pass http://192.168.24.100:9090/; proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection \u0026#34;Upgrade\u0026#34;; proxy_set_header Host $host; proxy_connect_timeout 60s; proxy_read_timeout 300s; proxy_send_timeout 300s; } location /socket.io { proxy_pass http://192.168.24.100:9091/; #Version 1.1 is recommended for use with keepalive connections proxy_http_version 1.1; #WebSocket proxy_set_header Upgrade $http_upgrade; #WebSocket proxy_set_header Connection $connection_upgrade; #WebSocket proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto https; proxy_set_header Cookie $http_cookie; } error_page 500 502 503 504 /50x.html; location = /50x.html { root /usr/share/nginx/html; } } 可以透過nginx -s reload讓nginx對新的配置生效","articleSection":"Posts","dateCreated":"2022-04-15T15:45:07+08:00","dateModified":"2022-04-15T15:45:07+08:00","headline":"Nginx Ingress Controller K8S Guide","inLanguage":"en-us","keywords":"Ingress, Kubernetes, Reverse Proxy","name":"Nginx Ingress Controller K8S Guide","timeRequired":"PT3M","url":"https://chienfuchen32.github.io/posts/nginx-ingress-controller-k8s-guide/","wordCount":546}</script><noscript>JavaScript is required</noscript></body></html>