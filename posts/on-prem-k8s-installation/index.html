<!doctype html><html lang=en-us><head><meta charset=utf-8><meta content="CNI,CSI,Kubernetes" name=keywords><meta content="width=device-width,initial-scale=1" name=viewport><meta property="og:title" content="On-Premises K8s Installation"><meta property="og:description" content="Load balancer & VIP HAProxy & Keepalived
Init HA control plane & worker node sudo kubeadm init --control-plane-endpoint &#34;LOAD_BALANCER_DNS:LOAD_BALANCER_PORT&#34; --upload-certs ... ... You can now join any number of control-plane node by running the following command on each as a root: kubeadm join 192.168.0.200:6443 --token 9vr73a.a8uxyaju799qwdjv --discovery-token-ca-cert-hash sha256:7c2e69131a36ae2a042a339b33381c6d0d43887e2de83720eff5359e26aec866 --control-plane --certificate-key f8902e114ef118304e561c3ecd4d0b543adc226b7a07f675f56564185ffe0c07 Please note that the certificate-key gives access to cluster sensitive data, keep it secret! As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use kubeadm init phase upload-certs to reload certs afterward."><meta property="og:type" content="article"><meta property="og:url" content="https://chienfuchen32.github.io/posts/on-prem-k8s-installation/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-09-18T10:00:04+08:00"><meta property="article:modified_time" content="2020-09-18T10:00:04+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="On-Premises K8s Installation"><meta name=twitter:description content="Load balancer & VIP HAProxy & Keepalived
Init HA control plane & worker node sudo kubeadm init --control-plane-endpoint &#34;LOAD_BALANCER_DNS:LOAD_BALANCER_PORT&#34; --upload-certs ... ... You can now join any number of control-plane node by running the following command on each as a root: kubeadm join 192.168.0.200:6443 --token 9vr73a.a8uxyaju799qwdjv --discovery-token-ca-cert-hash sha256:7c2e69131a36ae2a042a339b33381c6d0d43887e2de83720eff5359e26aec866 --control-plane --certificate-key f8902e114ef118304e561c3ecd4d0b543adc226b7a07f675f56564185ffe0c07 Please note that the certificate-key gives access to cluster sensitive data, keep it secret! As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use kubeadm init phase upload-certs to reload certs afterward."><title>On-Premises K8s Installation &#183; Jeffâ€™s note</title><link crossorigin=anonymous href=https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css integrity=sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx rel=stylesheet><link crossorigin=anonymous href=https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css rel=stylesheet></head><body class="d-flex flex-column"><div class="container flex-fill"><header><div class=row><div class=col><nav class="d-flex justify-content-center my-3"><ul class="nav nav-pills"><li class=nav-item><a href=/about/ class=nav-link>About</a></li><li class=nav-item><a href=/posts/ class="nav-link active">Posts</a></li><li class=nav-item><a href=/tags/ class=nav-link>Tags</a></li></ul></nav></div></div></header><main><article><header><div class="justify-content-center row"><div class="col col-auto text-center"><div style=max-width:100ch><h1 class="display-5 fw-bold">On-Premises K8s Installation</h1><p class=text-muted><time datetime=2020-09-18>September 18, 2020</time></p></div></div></div></header><div class="justify-content-center row"><div class="col col-auto"><div style=max-width:66ch><p><img src=https://d33wubrfki0l68.cloudfront.net/d1411cded83856552f37911eb4522d9887ca4e83/b94b2/images/kubeadm/kubeadm-ha-topology-stacked-etcd.svg alt=kubeadm-ha-topology></p><h4 id=load-balancer--vip>Load balancer & VIP</h4><p><a href=https://www.digitalocean.com/community/tutorials/how-to-set-up-highly-available-haproxy-servers-with-keepalived-and-reserved-ips-on-ubuntu-14-04>HAProxy & Keepalived</a></p><h4 id=init-ha-control-plane--worker-node>Init HA control plane & worker node</h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo kubeadm init --control-plane-endpoint <span style=color:#a31515>&#34;LOAD_BALANCER_DNS:LOAD_BALANCER_PORT&#34;</span> --upload-certs
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>You can now join any number of control-plane node by running the following command on each as a root:
</span></span><span style=display:flex><span>    kubeadm join 192.168.0.200:6443 --token 9vr73a.a8uxyaju799qwdjv --discovery-token-ca-cert-hash sha256:7c2e69131a36ae2a042a339b33381c6d0d43887e2de83720eff5359e26aec866 --control-plane --certificate-key f8902e114ef118304e561c3ecd4d0b543adc226b7a07f675f56564185ffe0c07
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Please note that the certificate-key gives access to cluster sensitive data, keep it secret!
</span></span><span style=display:flex><span>As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use kubeadm init phase upload-certs to reload certs afterward.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Then you can join any number of worker nodes by running the following on each as root:
</span></span><span style=display:flex><span>    kubeadm join 192.168.0.200:6443 --token 9vr73a.a8uxyaju799qwdjv --discovery-token-ca-cert-hash sha256:7c2e69131a36ae2a042a339b33381c6d0d43887e2de83720eff5359e26aec866
</span></span></code></pre></div><h4 id=networking-with-weave-net>Networking with Weave Net</h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl apply -f <span style=color:#a31515>&#34;https://cloud.weave.works/k8s/net?k8s-version=</span><span style=color:#00f>$(</span>kubectl version | base64 | tr -d <span style=color:#a31515>&#39;\n&#39;</span><span style=color:#00f>)</span><span style=color:#a31515>&#34;</span>
</span></span></code></pre></div><ul><li><a href=https://www.weave.works/docs/net/latest/overview/>https://www.weave.works/docs/net/latest/overview/</a></li><li><a href=https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/>https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/</a></li></ul><h4 id=ingress-controller-with-nginx>Ingress controller with Nginx</h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.3.1/deploy/static/provider/cloud/deploy.yaml
</span></span></code></pre></div><ul><li><a href=https://kubernetes.github.io/ingress-nginx/>https://kubernetes.github.io/ingress-nginx/</a></li></ul><h4 id=storage>Storage</h4><ul><li>Ceph
<img src=https://rook.io/docs/rook/v1.10/Getting-Started/ceph-storage/kubernetes.png alt="Rook Ceph"></li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ git clone --single-branch --branch v1.10.1 https://github.com/rook/rook.git
</span></span><span style=display:flex><span>$ cd rook/deploy/examples
</span></span><span style=display:flex><span>$ kubectl create -f crds.yaml -f common.yaml -f operator.yaml
</span></span><span style=display:flex><span>$ kubectl create -f cluster.yaml
</span></span></code></pre></div><ul><li><a href=https://rook.io/docs/rook/v1.10/Getting-Started/intro/>https://rook.io/docs/rook/v1.10/Getting-Started/intro/</a></li></ul><h4 id=monitoring>Monitoring</h4><ul><li>Prometheus, Grafana
<img src=https://prometheus.io/assets/architecture.png alt=Prometheus></li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
</span></span><span style=display:flex><span>$ helm repo update
</span></span><span style=display:flex><span>$ helm install -n [NAMESPACE] [RELEASE_NAME] prometheus-community/kube-prometheus-stack
</span></span></code></pre></div><ul><li><a href=https://prometheus.io>https://prometheus.io</a></li><li><a href=https://grafana.com/oss/grafana/>https://grafana.com/oss/grafana/</a></li></ul><h4 id=log>Log</h4><ul><li>Loki
<img src=https://grafana.com/static/img/logs/logs-loki-diagram.svg alt=Loki></li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ helm repo add grafana https://grafana.github.io/helm-charts
</span></span><span style=display:flex><span>$ helm repo update
</span></span><span style=display:flex><span>$ helm upgrade --install --namespace=[NAMESPACE] [RELEASE_NAME] grafana/loki-stack
</span></span></code></pre></div><ul><li><a href=https://grafana.com/oss/loki/>https://grafana.com/oss/loki/</a></li></ul></div></div></div></article></main></div><script crossorigin=anonymous integrity=sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa src=https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LR5QZYBPT2"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LR5QZYBPT2",{anonymize_ip:!1})}</script></body></html>