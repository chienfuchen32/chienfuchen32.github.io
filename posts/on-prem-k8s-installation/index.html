<!doctype html><html lang=en-us><head><meta charset=utf-8><meta content="Jeff’s note" name=apple-mobile-web-app-title><meta content="CNI,CSI,Kubernetes" name=keywords><meta content="#0d6efd" name=theme-color><meta content="width=device-width,initial-scale=1" name=viewport><meta property="og:url" content="https://chienfuchen32.github.io/posts/on-prem-k8s-installation/"><meta property="og:site_name" content="Jeff's note"><meta property="og:title" content="On-Premises K8s Installation"><meta property="og:description" content='Load balancer & VIP HAProxy & Keepalived Init HA control plane & worker node sudo kubeadm init --control-plane-endpoint "LOAD_BALANCER_DNS:LOAD_BALANCER_PORT" --upload-certs ... ... You can now join any number of control-plane node by running the following command on each as a root: kubeadm join 192.168.0.200:6443 --token 9vr73a.a8uxyaju799qwdjv --discovery-token-ca-cert-hash sha256:7c2e69131a36ae2a042a339b33381c6d0d43887e2de83720eff5359e26aec866 --control-plane --certificate-key f8902e114ef118304e561c3ecd4d0b543adc226b7a07f675f56564185ffe0c07 Please note that the certificate-key gives access to cluster sensitive data, keep it secret! As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use kubeadm init phase upload-certs to reload certs afterward. Then you can join any number of worker nodes by running the following on each as root: kubeadm join 192.168.0.200:6443 --token 9vr73a.a8uxyaju799qwdjv --discovery-token-ca-cert-hash sha256:7c2e69131a36ae2a042a339b33381c6d0d43887e2de83720eff5359e26aec866 Networking with Weave Net $ kubectl apply -f "https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d &#39;\n&#39;)" https://www.weave.works/docs/net/latest/overview/ https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/ Ingress controller with Nginx $ kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.3.1/deploy/static/provider/cloud/deploy.yaml https://kubernetes.github.io/ingress-nginx/ Storage Ceph $ git clone --single-branch --branch v1.10.1 https://github.com/rook/rook.git $ cd rook/deploy/examples $ kubectl create -f crds.yaml -f common.yaml -f operator.yaml $ kubectl create -f cluster.yaml https://rook.io/docs/rook/v1.10/Getting-Started/intro/ Monitoring Prometheus, Grafana $ helm repo add prometheus-community https://prometheus-community.github.io/helm-charts $ helm repo update $ helm install -n [NAMESPACE] [RELEASE_NAME] prometheus-community/kube-prometheus-stack https://prometheus.io https://grafana.com/oss/grafana/ Log Loki $ helm repo add grafana https://grafana.github.io/helm-charts $ helm repo update $ helm upgrade --install --namespace=[NAMESPACE] [RELEASE_NAME] grafana/loki-stack https://grafana.com/oss/loki/'><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-09-18T10:00:04+08:00"><meta property="article:modified_time" content="2020-09-18T10:00:04+08:00"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="CSI"><meta property="article:tag" content="CNI"><meta name=twitter:card content="summary"><meta name=twitter:title content="On-Premises K8s Installation"><meta name=twitter:description content='Load balancer & VIP HAProxy & Keepalived Init HA control plane & worker node sudo kubeadm init --control-plane-endpoint "LOAD_BALANCER_DNS:LOAD_BALANCER_PORT" --upload-certs ... ... You can now join any number of control-plane node by running the following command on each as a root: kubeadm join 192.168.0.200:6443 --token 9vr73a.a8uxyaju799qwdjv --discovery-token-ca-cert-hash sha256:7c2e69131a36ae2a042a339b33381c6d0d43887e2de83720eff5359e26aec866 --control-plane --certificate-key f8902e114ef118304e561c3ecd4d0b543adc226b7a07f675f56564185ffe0c07 Please note that the certificate-key gives access to cluster sensitive data, keep it secret! As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use kubeadm init phase upload-certs to reload certs afterward. Then you can join any number of worker nodes by running the following on each as root: kubeadm join 192.168.0.200:6443 --token 9vr73a.a8uxyaju799qwdjv --discovery-token-ca-cert-hash sha256:7c2e69131a36ae2a042a339b33381c6d0d43887e2de83720eff5359e26aec866 Networking with Weave Net $ kubectl apply -f "https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d &#39;\n&#39;)" https://www.weave.works/docs/net/latest/overview/ https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/ Ingress controller with Nginx $ kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.3.1/deploy/static/provider/cloud/deploy.yaml https://kubernetes.github.io/ingress-nginx/ Storage Ceph $ git clone --single-branch --branch v1.10.1 https://github.com/rook/rook.git $ cd rook/deploy/examples $ kubectl create -f crds.yaml -f common.yaml -f operator.yaml $ kubectl create -f cluster.yaml https://rook.io/docs/rook/v1.10/Getting-Started/intro/ Monitoring Prometheus, Grafana $ helm repo add prometheus-community https://prometheus-community.github.io/helm-charts $ helm repo update $ helm install -n [NAMESPACE] [RELEASE_NAME] prometheus-community/kube-prometheus-stack https://prometheus.io https://grafana.com/oss/grafana/ Log Loki $ helm repo add grafana https://grafana.github.io/helm-charts $ helm repo update $ helm upgrade --install --namespace=[NAMESPACE] [RELEASE_NAME] grafana/loki-stack https://grafana.com/oss/loki/'><title>On-Premises K8s Installation · Posts · Jeff’s note</title><link href=/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link href=/favicon-96x96.png rel=icon sizes=96x96 type=image/png><link href=/favicon.ico rel="shortcut icon"><link href=/favicon.svg rel=icon type=image/svg+xml><link href=/web-app-manifest-192x192.png rel=icon type=image/png><link href=/web-app-manifest-512x512.png rel=icon type=image/png><link href=/site.webmanifest rel=manifest><link crossorigin=anonymous href=/css/paige/paige.4319aa37893f2dde7f739996891c87c15755af36.min.3b5b583ef4a5c7e93743e15582585c9c2a7621b8fef6c9c7ad4bac50e4781f05.css integrity="sha256-O1tYPvSlx+k3Q+FVglhcnCp2Ibj+9snHrUusUOR4HwU=" referrerpolicy=no-referrer rel=stylesheet><link crossorigin=anonymous href=/css/paige/bootstrap/paige.37b3fc66686a7163af8180c5fb0fc6ab835321eb.min.55516fbe90a5aad46d6dbc2441c1c193504ee32cb1eef5070ab589c776231a4c.css integrity="sha256-VVFvvpClqtRtbbwkQcHBk1BO4yyx7vUHCrWJx3YjGkw=" referrerpolicy=no-referrer rel=stylesheet><link crossorigin=anonymous href=/css/paige/bootstrap-icons/bootstrap-icons.min.755bbaf60ab33d8f6213c74d33daea2ef5bf22d15245142a27529f8c1d7e80f1.css integrity="sha256-dVu69gqzPY9iE8dNM9rqLvW/ItFSRRQqJ1KfjB1+gPE=" referrerpolicy=no-referrer rel=stylesheet></head><body><div class=container><div class=row><div class="col mt-3" id=paige-site><header id=paige-site-header><div class="display-1 fw-bold text-center" id=paige-site-title><a class="text-body text-decoration-none" href=/>Jeff&rsquo;s note</a></div><nav aria-label=Menu class=paige-row-tall id=paige-site-menu><ul class="align-items-center justify-content-center nav"><li class=nav-item><a class="nav-link text-decoration-underline" href=/about/>About</a></li><li class=nav-item><a aria-current=page class="active fw-bold text-body nav-link text-decoration-underline" href=/posts/>Posts</a></li><li class=nav-item><a class="nav-link text-decoration-underline" href=/tags/>Tags</a></li></ul></nav><nav aria-label=Breadcrumbs class=paige-row-tall id=paige-site-breadcrumbs><div class="d-flex justify-content-center"><ol class="breadcrumb mb-0"><li class=breadcrumb-item><a href=/>Home</a></li><li class=breadcrumb-item><a href=/posts/>Posts</a></li></ol></div></nav></header><article class="align-items-center d-flex flex-column paige-kind-page paige-status-draft paige-status-unpublished" id=paige-page><header class="mw-100 text-center" id=paige-page-header><h1 class=fw-bold id=paige-page-title>On-Premises K8s Installation</h1><div><p class="paige-row-short text-secondary" id=paige-page-keywords><a class="link-secondary paige-page-keyword-tag" href=/tags/cni/>CNI</a>
·
<a class="link-secondary paige-page-keyword-tag" href=/tags/csi/>CSI</a>
·
<a class="link-secondary paige-page-keyword-tag" href=/tags/kubernetes/>Kubernetes</a></p><p class="paige-row-short text-secondary" id=paige-page-date><time datetime=2020-09-18>September 18, 2020</time></p><p class="paige-row-short text-secondary" id=paige-page-word-count>209 words</p><p class="paige-row-short text-secondary" id=paige-page-reading-time>1 minute</p></div><div class="align-items-center d-flex flex-column paige-row-tall text-start" id=paige-page-toc><div class="border rounded" style="padding:1rem 2rem 0 1rem"><nav id=TableOfContents><ul><li><ul><li></li></ul></li></ul></nav></div></div></header><main class=mw-100 id=paige-page-content><p><img src=https://d33wubrfki0l68.cloudfront.net/d1411cded83856552f37911eb4522d9887ca4e83/b94b2/images/kubeadm/kubeadm-ha-topology-stacked-etcd.svg alt=kubeadm-ha-topology></p><h4 class=h6 id=load-balancer--vip><a href=#load-balancer--vip style=color:rgba(var(--bs-body-color-rgb),var(--bs-text-opacity));text-decoration:none>Load balancer & VIP</a></h4><p><a href=https://www.digitalocean.com/community/tutorials/how-to-set-up-highly-available-haproxy-servers-with-keepalived-and-reserved-ips-on-ubuntu-14-04 rel=external>HAProxy & Keepalived</a></p><h4 class=h6 id=init-ha-control-plane--worker-node><a href=#init-ha-control-plane--worker-node style=color:rgba(var(--bs-body-color-rgb),var(--bs-text-opacity));text-decoration:none>Init HA control plane & worker node</a></h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo kubeadm init --control-plane-endpoint <span style=color:#a31515>&#34;LOAD_BALANCER_DNS:LOAD_BALANCER_PORT&#34;</span> --upload-certs
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>You can now join any number of control-plane node by running the following command on each as a root:
</span></span><span style=display:flex><span>    kubeadm join 192.168.0.200:6443 --token 9vr73a.a8uxyaju799qwdjv --discovery-token-ca-cert-hash sha256:7c2e69131a36ae2a042a339b33381c6d0d43887e2de83720eff5359e26aec866 --control-plane --certificate-key f8902e114ef118304e561c3ecd4d0b543adc226b7a07f675f56564185ffe0c07
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Please note that the certificate-key gives access to cluster sensitive data, keep it secret!
</span></span><span style=display:flex><span>As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use kubeadm init phase upload-certs to reload certs afterward.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Then you can join any number of worker nodes by running the following on each as root:
</span></span><span style=display:flex><span>    kubeadm join 192.168.0.200:6443 --token 9vr73a.a8uxyaju799qwdjv --discovery-token-ca-cert-hash sha256:7c2e69131a36ae2a042a339b33381c6d0d43887e2de83720eff5359e26aec866
</span></span></code></pre></div><h4 class=h6 id=networking-with-weave-net><a href=#networking-with-weave-net style=color:rgba(var(--bs-body-color-rgb),var(--bs-text-opacity));text-decoration:none>Networking with Weave Net</a></h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl apply -f <span style=color:#a31515>&#34;https://cloud.weave.works/k8s/net?k8s-version=</span><span style=color:#00f>$(</span>kubectl version | base64 | tr -d <span style=color:#a31515>&#39;\n&#39;</span><span style=color:#00f>)</span><span style=color:#a31515>&#34;</span>
</span></span></code></pre></div><ul><li><a href=https://www.weave.works/docs/net/latest/overview/ rel=external>https://www.weave.works/docs/net/latest/overview/</a></li><li><a href=https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/ rel=external>https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/</a></li></ul><h4 class=h6 id=ingress-controller-with-nginx><a href=#ingress-controller-with-nginx style=color:rgba(var(--bs-body-color-rgb),var(--bs-text-opacity));text-decoration:none>Ingress controller with Nginx</a></h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.3.1/deploy/static/provider/cloud/deploy.yaml
</span></span></code></pre></div><ul><li><a href=https://kubernetes.github.io/ingress-nginx/ rel=external>https://kubernetes.github.io/ingress-nginx/</a></li></ul><h4 class=h6 id=storage><a href=#storage style=color:rgba(var(--bs-body-color-rgb),var(--bs-text-opacity));text-decoration:none>Storage</a></h4><ul><li>Ceph
<img src=https://rook.io/docs/rook/v1.10/Getting-Started/ceph-storage/kubernetes.png alt="Rook Ceph"></li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ git clone --single-branch --branch v1.10.1 https://github.com/rook/rook.git
</span></span><span style=display:flex><span>$ cd rook/deploy/examples
</span></span><span style=display:flex><span>$ kubectl create -f crds.yaml -f common.yaml -f operator.yaml
</span></span><span style=display:flex><span>$ kubectl create -f cluster.yaml
</span></span></code></pre></div><ul><li><a href=https://rook.io/docs/rook/v1.10/Getting-Started/intro/ rel=external>https://rook.io/docs/rook/v1.10/Getting-Started/intro/</a></li></ul><h4 class=h6 id=monitoring><a href=#monitoring style=color:rgba(var(--bs-body-color-rgb),var(--bs-text-opacity));text-decoration:none>Monitoring</a></h4><ul><li>Prometheus, Grafana
<img src=https://prometheus.io/assets/architecture.png alt=Prometheus></li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
</span></span><span style=display:flex><span>$ helm repo update
</span></span><span style=display:flex><span>$ helm install -n [NAMESPACE] [RELEASE_NAME] prometheus-community/kube-prometheus-stack
</span></span></code></pre></div><ul><li><a href=https://prometheus.io rel=external>https://prometheus.io</a></li><li><a href=https://grafana.com/oss/grafana/ rel=external>https://grafana.com/oss/grafana/</a></li></ul><h4 class=h6 id=log><a href=#log style=color:rgba(var(--bs-body-color-rgb),var(--bs-text-opacity));text-decoration:none>Log</a></h4><ul><li>Loki
<img src=https://grafana.com/static/img/logs/logs-loki-diagram.svg alt=Loki></li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ helm repo add grafana https://grafana.github.io/helm-charts
</span></span><span style=display:flex><span>$ helm repo update
</span></span><span style=display:flex><span>$ helm upgrade --install --namespace=[NAMESPACE] [RELEASE_NAME] grafana/loki-stack
</span></span></code></pre></div><ul><li><a href=https://grafana.com/oss/loki/ rel=external>https://grafana.com/oss/loki/</a></li></ul></main><footer class=mw-100 id=paige-page-footer><div id=paige-page-siblings><div class="paige-row-short text-center text-secondary" id=paige-page-prev>&#8249; <a class=link-secondary href=https://chienfuchen32.github.io/posts/luks-tang/>Disk encryption: LUKS ( Linux Unified Key Setup) with Tang</a></div></div></footer></article><footer id=paige-site-footer><p class="paige-row-short text-center text-secondary" id=paige-site-credit><a class="link-secondary text-decoration-none" href=https://github.com/willfaught/paige>Paige Theme</a></p></footer></div></div></div><script crossorigin=anonymous defer integrity="sha256-GdpV5fXTSprZ1he71RUKGZl0E3HtqxFXvbylEdkWmRQ=" referrerpolicy=no-referrer src=/js/paige/bootstrap/bootstrap.bundle.min.19da55e5f5d34a9ad9d617bbd5150a1999741371edab1157bdbca511d9169914.js></script><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","abstract":"\nLoad balancer \u0026 VIP HAProxy \u0026 Keepalived Init HA control plane \u0026 worker node sudo kubeadm init --control-plane-endpoint \"LOAD_BALANCER_DNS:LOAD_BALANCER_PORT\" --upload-certs ... ... You can now join any number of control-plane node by running the following command on each as a root: kubeadm join 192.168.0.200:6443 --token 9vr73a.a8uxyaju799qwdjv --discovery-token-ca-cert-hash sha256:7c2e69131a36ae2a042a339b33381c6d0d43887e2de83720eff5359e26aec866 --control-plane --certificate-key f8902e114ef118304e561c3ecd4d0b543adc226b7a07f675f56564185ffe0c07 Please note that the certificate-key gives access to cluster sensitive data, keep it secret! As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use kubeadm init phase upload-certs to reload certs afterward. Then you can join any number of worker nodes by running the following on each as root: kubeadm join 192.168.0.200:6443 --token 9vr73a.a8uxyaju799qwdjv --discovery-token-ca-cert-hash sha256:7c2e69131a36ae2a042a339b33381c6d0d43887e2de83720eff5359e26aec866 Networking with Weave Net $ kubectl apply -f \"https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d '\\n')\" https://www.weave.works/docs/net/latest/overview/ https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/ Ingress controller with Nginx $ kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.3.1/deploy/static/provider/cloud/deploy.yaml https://kubernetes.github.io/ingress-nginx/ Storage Ceph $ git clone --single-branch --branch v1.10.1 https://github.com/rook/rook.git $ cd rook/deploy/examples $ kubectl create -f crds.yaml -f common.yaml -f operator.yaml $ kubectl create -f cluster.yaml https://rook.io/docs/rook/v1.10/Getting-Started/intro/ Monitoring Prometheus, Grafana $ helm repo add prometheus-community https://prometheus-community.github.io/helm-charts $ helm repo update $ helm install -n [NAMESPACE] [RELEASE_NAME] prometheus-community/kube-prometheus-stack https://prometheus.io https://grafana.com/oss/grafana/ Log Loki $ helm repo add grafana https://grafana.github.io/helm-charts $ helm repo update $ helm upgrade --install --namespace=[NAMESPACE] [RELEASE_NAME] grafana/loki-stack https://grafana.com/oss/loki/ ","articleSection":"Posts","dateCreated":"2020-09-18T10:00:04+08:00","dateModified":"2020-09-18T10:00:04+08:00","headline":"On-Premises K8s Installation","inLanguage":"en-us","keywords":"CNI, CSI, Kubernetes","name":"On-Premises K8s Installation","timeRequired":"PT1M","url":"https://chienfuchen32.github.io/posts/on-prem-k8s-installation/","wordCount":209}</script><noscript>JavaScript is required</noscript></body></html>