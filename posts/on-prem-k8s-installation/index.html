<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.102.3"><meta name=viewport content="width=device-width,initial-scale=1"><title>On-Premises K8s Installation &#183; New Blog</title><meta name=description content><link type=text/css rel=stylesheet href=https://chienfuchen32.github.io/css/print.css media=print><link type=text/css rel=stylesheet href=https://chienfuchen32.github.io/css/poole.css><link type=text/css rel=stylesheet href=https://chienfuchen32.github.io/css/syntax.css><link type=text/css rel=stylesheet href=https://chienfuchen32.github.io/css/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body class=theme-base-0d><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://chienfuchen32.github.io/><h1>New Blog</h1></a><p class=lead>hello there!</p></div><nav><ul class=sidebar-nav><li><a href=https://chienfuchen32.github.io/>Home</a></li><li><a href=https://github.com/chienfuchen32/>Github</a></li><li><a href=https://chienfuchen32.github.io/tags/>Tags</a></li></ul></nav><p>&copy; 2022. All rights reserved.</p></div></aside><main class="content container"><div class=post><h1>On-Premises K8s Installation</h1><time datetime=2020-09-18T10:00:04+0800 class=post-date>Fri, Sep 18, 2020</time><p><img src=https://d33wubrfki0l68.cloudfront.net/d1411cded83856552f37911eb4522d9887ca4e83/b94b2/images/kubeadm/kubeadm-ha-topology-stacked-etcd.svg alt=kubeadm-ha-topology></p><h4 id=load-balancer--vip>Load balancer & VIP</h4><p><a href=https://www.digitalocean.com/community/tutorials/how-to-set-up-highly-available-haproxy-servers-with-keepalived-and-reserved-ips-on-ubuntu-14-04>HAProxy & Keepalived</a></p><h4 id=init-ha-control-plane--worker-node>Init HA control plane & worker node</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo kubeadm init --control-plane-endpoint <span style=color:#e6db74>&#34;LOAD_BALANCER_DNS:LOAD_BALANCER_PORT&#34;</span> --upload-certs
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>You can now join any number of control-plane node by running the following command on each as a root:
</span></span><span style=display:flex><span>    kubeadm join 192.168.0.200:6443 --token 9vr73a.a8uxyaju799qwdjv --discovery-token-ca-cert-hash sha256:7c2e69131a36ae2a042a339b33381c6d0d43887e2de83720eff5359e26aec866 --control-plane --certificate-key f8902e114ef118304e561c3ecd4d0b543adc226b7a07f675f56564185ffe0c07
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Please note that the certificate-key gives access to cluster sensitive data, keep it secret!
</span></span><span style=display:flex><span>As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use kubeadm init phase upload-certs to reload certs afterward.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Then you can join any number of worker nodes by running the following on each as root:
</span></span><span style=display:flex><span>    kubeadm join 192.168.0.200:6443 --token 9vr73a.a8uxyaju799qwdjv --discovery-token-ca-cert-hash sha256:7c2e69131a36ae2a042a339b33381c6d0d43887e2de83720eff5359e26aec866
</span></span></code></pre></div><h4 id=networking-with-weave-net>Networking with Weave Net</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl apply -f <span style=color:#e6db74>&#34;https://cloud.weave.works/k8s/net?k8s-version=</span><span style=color:#66d9ef>$(</span>kubectl version | base64 | tr -d <span style=color:#e6db74>&#39;\n&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><ul><li><a href=https://www.weave.works/docs/net/latest/overview/>https://www.weave.works/docs/net/latest/overview/</a></li><li><a href=https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/>https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/</a></li></ul><h4 id=ingress-controller-with-nginx>Ingress controller with Nginx</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.3.1/deploy/static/provider/cloud/deploy.yaml
</span></span></code></pre></div><ul><li><a href=https://kubernetes.github.io/ingress-nginx/>https://kubernetes.github.io/ingress-nginx/</a></li></ul><h4 id=storage>Storage</h4><ul><li>Ceph
<img src=https://rook.io/docs/rook/v1.10/Getting-Started/ceph-storage/kubernetes.png alt="Rook Ceph"></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ git clone --single-branch --branch v1.10.1 https://github.com/rook/rook.git
</span></span><span style=display:flex><span>$ cd rook/deploy/examples
</span></span><span style=display:flex><span>$ kubectl create -f crds.yaml -f common.yaml -f operator.yaml
</span></span><span style=display:flex><span>$ kubectl create -f cluster.yaml
</span></span></code></pre></div><ul><li><a href=https://rook.io/docs/rook/v1.10/Getting-Started/intro/>https://rook.io/docs/rook/v1.10/Getting-Started/intro/</a></li></ul><h4 id=monitoring>Monitoring</h4><ul><li>Prometheus, Grafana
<img src=https://prometheus.io/assets/architecture.png alt=Prometheus></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
</span></span><span style=display:flex><span>$ helm repo update
</span></span><span style=display:flex><span>$ helm install -n <span style=color:#f92672>[</span>NAMESPACE<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>RELEASE_NAME<span style=color:#f92672>]</span> prometheus-community/kube-prometheus-stack
</span></span></code></pre></div><ul><li><a href=https://prometheus.io>https://prometheus.io</a></li><li><a href=https://grafana.com/oss/grafana/>https://grafana.com/oss/grafana/</a></li></ul><h4 id=log>Log</h4><ul><li>Loki
<img src=https://grafana.com/static/img/logs/logs-loki-diagram.svg alt=Loki></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ helm repo add grafana https://grafana.github.io/helm-charts
</span></span><span style=display:flex><span>$ helm repo update
</span></span><span style=display:flex><span>$ helm upgrade --install --namespace<span style=color:#f92672>=[</span>NAMESPACE<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>RELEASE_NAME<span style=color:#f92672>]</span> grafana/loki-stack
</span></span></code></pre></div><ul><li><a href=https://grafana.com/oss/loki/>https://grafana.com/oss/loki/</a></li></ul></div></main><script async src="https://www.googletagmanager.com/gtag/js?id=G-3SNCDP141D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3SNCDP141D",{anonymize_ip:!1})}</script></body></html>